openapi: 3.1.0
info:
  title: Yoked API
  description: |
    Yoked dating app REST API specification.
    
    All timestamps are ISO 8601 UTC unless specified otherwise.
    All requests require authentication via Bearer token except `/auth/*` endpoints.
  version: 1.0.0
  contact:
    name: Yoked Engineering

servers:
  - url: https://api.yoked.app/v1
    description: Production
  - url: https://api.staging.yoked.app/v1
    description: Staging

security:
  - bearerAuth: []

paths:
  /health:
    get:
      summary: Service health check
      description: Lightweight liveness endpoint for load balancers and clients.
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    enum: [ok]
                  timestamp:
                    type: string
                    format: date-time
                  version:
                    type: string

  # Authentication
  /auth/otp/send:
    post:
      summary: Send OTP to phone number
      description: Initiates phone verification by sending SMS OTP
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [phoneNumber, countryCode]
              properties:
                phoneNumber:
                  type: string
                  pattern: '^[0-9]{7,15}$'
                  example: "5551234567"
                countryCode:
                  type: string
                  pattern: '^[0-9]{1,3}$'
                  example: "1"
                deviceId:
                  type: string
                  description: Unique device identifier for fraud detection
      responses:
        '200':
          description: OTP sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  requestId:
                    type: string
                    format: uuid
                  expiresAt:
                    type: string
                    format: date-time
                  retryAfter:
                    type: integer
                    description: Seconds before retry allowed
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/otp/verify:
    post:
      summary: Verify OTP and create/authenticate user
      description: Verifies OTP and returns authentication tokens
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [requestId, code]
              properties:
                requestId:
                  type: string
                  format: uuid
                code:
                  type: string
                  pattern: '^[0-9]{6}$'
                  example: "123456"
                deviceId:
                  type: string
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                    description: JWT access token (15 min expiry)
                  refreshToken:
                    type: string
                    description: Long-lived refresh token
                  expiresIn:
                    type: integer
                    description: Seconds until access token expires
                  user:
                    $ref: '#/components/schemas/User'
                  onboardingStatus:
                    type: string
                    description: Derived onboarding status mapped from `users.onboarding_step`, `users.status`, and VPS readiness (see `docs/specs/onboarding.md` mapping table).
                    enum: [complete, questionnaire_pending, vps_pending, verification_pending, blocked]
        '401':
          description: Invalid or expired OTP
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/social/apple:
    post:
      summary: Sign in with Apple
      description: Authenticate via Apple Sign In, requires linked phone
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [identityToken, authorizationCode]
              properties:
                identityToken:
                  type: string
                  description: Apple identity token (JWT)
                authorizationCode:
                  type: string
                  description: Apple authorization code
                deviceId:
                  type: string
      responses:
        '200':
          description: Authentication successful or phone linking required
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      accessToken:
                        type: string
                      refreshToken:
                        type: string
                      user:
                        $ref: '#/components/schemas/User'
                  - type: object
                    properties:
                      requiresPhoneLink:
                        type: boolean
                        example: true
                      socialAuthId:
                        type: string
                        description: Temporary ID for phone linking flow

  /auth/social/google:
    post:
      summary: Sign in with Google
      description: Authenticate via Google Sign In, requires linked phone
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [idToken]
              properties:
                idToken:
                  type: string
                  description: Google ID token
                deviceId:
                  type: string
      responses:
        '200':
          description: Authentication successful or phone linking required
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      accessToken:
                        type: string
                      refreshToken:
                        type: string
                      user:
                        $ref: '#/components/schemas/User'
                  - type: object
                    properties:
                      requiresPhoneLink:
                        type: boolean
                        example: true
                      socialAuthId:
                        type: string

  /auth/refresh:
    post:
      summary: Refresh access token
      description: Exchange refresh token for new access token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken:
                  type: string
      responses:
        '200':
          description: New tokens issued
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                  refreshToken:
                    type: string
                  expiresIn:
                    type: integer

  /auth/logout:
    post:
      summary: Logout and revoke tokens
      responses:
        '204':
          description: Logout successful

  /auth/recovery/request:
    post:
      summary: Request account recovery
      description: Initiates assisted recovery with hold period
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [phoneNumber, reason]
              properties:
                phoneNumber:
                  type: string
                reason:
                  type: string
                  enum: [lost_device, forgot_pin, suspicious_activity, other]
      responses:
        '202':
          description: Recovery request accepted, manual review pending
          content:
            application/json:
              schema:
                type: object
                properties:
                  recoveryId:
                    type: string
                    format: uuid
                  holdUntil:
                    type: string
                    format: date-time
                    description: 72-hour hold period

  # User Profile
  /users/me:
    get:
      summary: Get current user profile
      responses:
        '200':
          description: User profile retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

    patch:
      summary: Update user profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                displayName:
                  type: string
                  maxLength: 50
                bio:
                  type: string
                  maxLength: 500
                location:
                  $ref: '#/components/schemas/Location'
                discoveryPreferences:
                  type: object
                  description: Integrated profiling preference inputs used alongside psychological answers for matchmaking (field name retained for API compatibility).
                  properties:
                    minAgePreference:
                      type: integer
                      minimum: 18
                      maximum: 120
                    maxAgePreference:
                      type: integer
                      minimum: 18
                      maximum: 120
                    maxDistanceKm:
                      type: integer
                      minimum: 1
                      maximum: 500
                    relationshipIntent:
                      type: string
                      enum: [casual, serious, marriage, unsure]
                    physicalPreferences:
                      type: array
                      maxItems: 5
                      description: Lightweight user-stated physical preference tags captured in integrated profiling and used for affinity scoring.
                      items:
                        type: string
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /users/me/photos:
    post:
      summary: Upload profile photo
      description: Upload photo after Photo Studio Lite verification
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [photo]
              properties:
                photo:
                  type: string
                  format: binary
                isPrimary:
                  type: boolean
                  default: false
      responses:
        '201':
          description: Photo uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Photo'

  /users/me/photos/{photoId}:
    delete:
      summary: Delete profile photo
      parameters:
        - name: photoId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Photo deleted

  # Compatibility Questionnaire
  /compatibility/questions:
    get:
      summary: Get questionnaire
      description: Retrieve current question set with user's previous answers
      responses:
        '200':
          description: Questionnaire retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  version:
                    type: string
                    description: Question set version ID
                  questions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Question'

  /compatibility/responses:
    post:
      summary: Submit questionnaire responses
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [version, responses]
              properties:
                version:
                  type: string
                  description: Question set version being answered
                responses:
                  type: array
                  items:
                    type: object
                    required: [questionId, answer]
                    properties:
                      questionId:
                        type: string
                        format: uuid
                      answer:
                        oneOf:
                          - type: string
                          - type: number
                          - type: array
                            items:
                              type: string
      responses:
        '200':
          description: Responses saved
          content:
            application/json:
              schema:
                type: object
                properties:
                  completionPercentage:
                    type: integer
                    minimum: 0
                    maximum: 100
                  nextStep:
                    type: string
                    enum: [photo_verification, matching, complete]

  # Visual Preference Studio
  /visual-preferences/session:
    get:
      summary: Get visual preference session
      description: Retrieve pairwise reference-image tasks for onboarding or recalibration.
      parameters:
        - name: mode
          in: query
          schema:
            type: string
            enum: [onboarding, recalibration]
            default: onboarding
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 40
            default: 20
      responses:
        '200':
          description: Visual preference session retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VisualPreferenceSession'

  /visual-preferences/choices:
    post:
      summary: Submit visual preference choices
      description: Submit pairwise choice outcomes and client-side timing/event metadata.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sessionId, choices]
              properties:
                sessionId:
                  type: string
                  format: uuid
                choices:
                  type: array
                  minItems: 1
                  maxItems: 50
                  items:
                    $ref: '#/components/schemas/VisualPreferenceChoice'
      responses:
        '200':
          description: Choices accepted
          content:
            application/json:
              schema:
                type: object
                required: [acceptedCount, remainingPairs, confidence, nextStep]
                properties:
                  acceptedCount:
                    type: integer
                    minimum: 0
                  remainingPairs:
                    type: integer
                    minimum: 0
                  confidence:
                    type: number
                    minimum: 0
                    maximum: 1
                    description: Confidence of learned preference profile after this submission.
                  profileUpdated:
                    type: boolean
                    description: True when this submission produced a new preference profile snapshot.
                  profileSnapshotId:
                    type: string
                    format: uuid
                    description: ID of the newly persisted profile snapshot, when available.
                  modelVersion:
                    type: string
                    description: Model version used to process this submission.
                  nextStep:
                    type: string
                    enum: [continue, refine, complete, matching]

  /visual-preferences/profile:
    get:
      summary: Get visual preference profile
      description: Returns status and confidence for the user's learned visual preference profile.
      responses:
        '200':
          description: Visual preference profile retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VisualPreferenceProfile'

  /visual-preferences/profile/snapshots:
    get:
      summary: List visual preference profile snapshots
      description: Retrieve historical confidence/profile snapshots for auditability and debugging.
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: before
          in: query
          schema:
            type: string
            format: date-time
            description: Return snapshots created before this timestamp.
      responses:
        '200':
          description: Visual preference snapshots retrieved
          content:
            application/json:
              schema:
                type: object
                required: [snapshots]
                properties:
                  snapshots:
                    type: array
                    items:
                      $ref: '#/components/schemas/VisualPreferenceProfileSnapshot'

  /visual-preferences/recalibrate:
    post:
      summary: Start visual preference recalibration
      description: Creates a new recalibration session for refreshing stale visual preference data.
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                targetPairs:
                  type: integer
                  minimum: 5
                  maximum: 40
                  default: 12
      responses:
        '201':
          description: Recalibration session created
          content:
            application/json:
              schema:
                type: object
                required: [sessionId, mode, expiresAt, suggestedPairs]
                properties:
                  sessionId:
                    type: string
                    format: uuid
                  mode:
                    type: string
                    enum: [recalibration]
                  expiresAt:
                    type: string
                    format: date-time
                  suggestedPairs:
                    type: integer
                    minimum: 5
                    maximum: 40

  # Photo Studio Recommendations
  /photo-studio/recommendations:
    post:
      summary: Recommend best profile photos
      description: Rank the user's uploaded photos and return recommended profile set.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [photoIds]
              properties:
                photoIds:
                  type: array
                  minItems: 3
                  maxItems: 12
                  items:
                    type: string
                    format: uuid
                includeSelfSelection:
                  type: boolean
                  default: true
                  description: If true, blend user pairwise picks with quality ranking.
                maxRecommendations:
                  type: integer
                  minimum: 1
                  maximum: 6
                  default: 4
      responses:
        '200':
          description: Photo recommendations generated
          content:
            application/json:
              schema:
                type: object
                required: [recommendations]
                properties:
                  recommendations:
                    type: array
                    items:
                      $ref: '#/components/schemas/PhotoRecommendation'
                  rejectedPhotos:
                    type: array
                    description: Photos excluded due to quality or policy checks.
                    items:
                      type: object
                      required: [photoId, reason]
                      properties:
                        photoId:
                          type: string
                          format: uuid
                        reason:
                          type: string
                          enum: [blur, low_light, occluded_face, policy_violation, duplicate]

  # Photo Studio Lite (Verification)
  /verification/session:
    post:
      summary: Create verification session
      description: Start Photo Studio Lite liveness verification
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [consentVersion]
              properties:
                consentVersion:
                  type: string
                  description: Version of biometric consent agreed to
      responses:
        '201':
          description: Session created
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionId:
                    type: string
                    format: uuid
                  uploadUrl:
                    type: string
                    format: uri
                    description: Presigned URL for selfie upload
                  expiresAt:
                    type: string
                    format: date-time

  /verification/session/{sessionId}/complete:
    post:
      summary: Complete verification
      description: Submit verification after upload
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Verification result
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [verified, failed, manual_review]
                  faceVectorId:
                    type: string
                    description: Derived vector ID (internal use)
                  failureReason:
                    type: string
                    enum: [liveness_failed, age_verification_failed, quality_too_low, policy_violation]

  # Matching
  /matches/offers:
    get:
      summary: Get daily match offers
      description: Retrieve today's curated match offers
      responses:
        '200':
          description: Match offers retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  batchDate:
                    type: string
                    format: date
                  generatedAt:
                    type: string
                    format: date-time
                    description: Timestamp when this batch was generated for the user's local day.
                  userTimezone:
                    type: string
                    description: IANA timezone used for local 9 AM batch scheduling.
                  offers:
                    type: array
                    items:
                      $ref: '#/components/schemas/MatchOffer'

  /matches/offers/{offerId}/action:
    post:
      summary: Take action on match offer
      description: Accept, pass, or defer a match offer
      parameters:
        - name: offerId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [action]
              properties:
                action:
                  type: string
                  enum: [accept, pass, not_now]
      responses:
        '200':
          description: Action recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  offer:
                    $ref: '#/components/schemas/MatchOffer'
                  isMutual:
                    type: boolean
                    description: True if both users accepted

  /matches:
    get:
      summary: List active matches
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [active, closed, all]
            default: active
      responses:
        '200':
          description: Matches retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  matches:
                    type: array
                    items:
                      $ref: '#/components/schemas/Match'

  /matches/{matchId}:
    get:
      summary: Get match details
      parameters:
        - name: matchId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Match details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Match'

  /matches/{matchId}/unmatch:
    post:
      summary: Unmatch
      description: Close match and stop chat
      parameters:
        - name: matchId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  enum: [not_interested, inappropriate, other]
      responses:
        '200':
          description: Unmatched successfully

  # Chat
  /matches/{matchId}/messages:
    get:
      summary: Get messages
      description: Retrieve chat messages with pagination
      parameters:
        - name: matchId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: before
          in: query
          schema:
            type: string
            format: uuid
          description: Message ID for pagination (get messages before this)
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: Messages retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  messages:
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
                  hasMore:
                    type: boolean

    post:
      summary: Send message
      description: Send a text message in a match. In MVP, either matched user may send the first message.
      parameters:
        - name: matchId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
                type: object
                required: [content, clientMessageId]
                properties:
                  content:
                    type: string
                    maxLength: 2000
                clientMessageId:
                  type: string
                  description: Client-generated ID for idempotency
      responses:
        '201':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
        '409':
          description: Duplicate message (same clientMessageId)

  /matches/{matchId}/read:
    post:
      summary: Mark messages as read
      parameters:
        - name: matchId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                upToMessageId:
                  type: string
                  format: uuid
                  description: Mark all messages up to this ID as read
      responses:
        '200':
          description: Read status updated

  # Safety
  /safety/report:
    post:
      summary: Submit safety report
      description: Report user or content for moderation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [type, subjectId, category]
              properties:
                type:
                  type: string
                  enum: [user, message, match]
                subjectId:
                  type: string
                  format: uuid
                  description: ID of reported user, message, or match
                category:
                  type: string
                  enum: [harassment, inappropriate_content, scam, violence, self_harm, child_safety, other]
                severity:
                  type: string
                  enum: [critical, high, standard]
                  description: Auto-classified if not provided
                description:
                  type: string
                  maxLength: 2000
                evidence:
                  type: array
                  items:
                    type: string
                    format: uuid
                  description: Message IDs or screenshot references
      responses:
        '201':
          description: Report submitted
          content:
            application/json:
              schema:
                type: object
                properties:
                  reportId:
                    type: string
                    format: uuid
                  estimatedResponse:
                    type: string
                    description: Human-readable response time estimate

  /safety/block:
    post:
      summary: Block user
      description: Block user and close any active match
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [userId]
              properties:
                userId:
                  type: string
                  format: uuid
                reason:
                  type: string
                  enum: [inappropriate, harassment, no_reason]
      responses:
        '200':
          description: User blocked

  /users/me/blocks:
    get:
      summary: List blocked users
      responses:
        '200':
          description: Blocked users retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  blocks:
                    type: array
                    items:
                      type: object
                      properties:
                        userId:
                          type: string
                          format: uuid
                        blockedAt:
                          type: string
                          format: date-time

  /users/me/blocks/{userId}:
    delete:
      summary: Unblock user
      description: Remove a user from the caller's block list.
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: User unblocked

  /safety/appeal:
    post:
      summary: Submit account appeal
      description: Appeal suspension or enforcement action
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [actionId, reason]
              properties:
                actionId:
                  type: string
                  description: ID of enforcement action being appealed
                reason:
                  type: string
                  maxLength: 2000
      responses:
        '201':
          description: Appeal submitted
          content:
            application/json:
              schema:
                type: object
                properties:
                  appealId:
                    type: string
                    format: uuid

  /admin/metrics/cohorts:
    get:
      summary: Get cohort metric timeseries
      description: |
        Returns aggregated metric time series by cohort slice.
        Admin access required.
      parameters:
        - name: metricKey
          in: query
          required: true
          schema:
            type: string
            enum:
              - too_few_messages_rate
              - too_many_messages_rate
              - unwanted_content_report_rate_per_1k
              - mutual_match_rate
              - reply_within_24h_rate
              - unmatch_7d_rate
              - decision_fatigue_rate
              - exposure_acceptance_parity_delta
        - name: dateFrom
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: dateTo
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: granularity
          in: query
          required: false
          schema:
            type: string
            enum: [daily, weekly]
            default: daily
        - name: cohortDimension
          in: query
          required: false
          schema:
            type: string
            enum: [gender_identity, policy_segment, region]
            default: gender_identity
        - name: cohortValue
          in: query
          required: false
          schema:
            type: string
            description: Optional cohort value filter; omitted means all.
        - name: policySegment
          in: query
          required: false
          schema:
            type: string
            enum: [all, high_inbound_pressure, low_inbound_low_response, balanced]
            default: all
        - name: region
          in: query
          required: false
          schema:
            type: string
            description: ISO country code or `all`.
            default: all
      responses:
        '200':
          description: Cohort metric timeseries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CohortMetricTimeseriesResponse'
        '400':
          description: Invalid metric query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Admin role required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/metrics/cohorts/summary:
    get:
      summary: Get latest cohort metric summary
      description: |
        Returns latest values and week-over-week deltas for configured cohort metrics.
        Admin access required.
      parameters:
        - name: cohortDimension
          in: query
          required: false
          schema:
            type: string
            enum: [gender_identity, policy_segment, region]
            default: gender_identity
        - name: policySegment
          in: query
          required: false
          schema:
            type: string
            enum: [all, high_inbound_pressure, low_inbound_low_response, balanced]
            default: all
        - name: region
          in: query
          required: false
          schema:
            type: string
            default: all
        - name: metricKeys
          in: query
          required: false
          schema:
            type: array
            items:
              type: string
          style: form
          explode: false
          description: Optional comma-separated metric key list.
      responses:
        '200':
          description: Cohort metric summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CohortMetricSummaryResponse'
        '403':
          description: Admin role required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/metrics/alerts:
    get:
      summary: List cohort metric alerts
      description: Returns metric parity/safety alerts generated by monitoring jobs. Admin access required.
      parameters:
        - name: severity
          in: query
          required: false
          schema:
            type: string
            enum: [critical, high, medium]
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [open, acknowledged, resolved, muted]
        - name: dateFrom
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: dateTo
          in: query
          required: false
          schema:
            type: string
            format: date
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Alert list retrieved
          content:
            application/json:
              schema:
                type: object
                required: [alerts, pagination]
                properties:
                  alerts:
                    type: array
                    items:
                      $ref: '#/components/schemas/CohortMetricAlert'
                  pagination:
                    type: object
                    required: [limit, offset, total]
                    properties:
                      limit:
                        type: integer
                      offset:
                        type: integer
                      total:
                        type: integer
        '403':
          description: Admin role required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token from /auth endpoints

  schemas:
    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object

    User:
      type: object
      required: [id, phoneNumber, status, createdAt]
      properties:
        id:
          type: string
          format: uuid
        phoneNumber:
          type: string
          description: Last 4 digits only for display
          example: "***-***-4567"
        displayName:
          type: string
        bio:
          type: string
        age:
          type: integer
        location:
          $ref: '#/components/schemas/Location'
        photos:
          type: array
          items:
            $ref: '#/components/schemas/Photo'
        status:
          type: string
          enum: [active, suspended, pending_verification, non_matching, deleted]
        onboardingStatus:
          type: string
          description: Derived onboarding status mapped from `users.onboarding_step`, `users.status`, and VPS readiness (see `docs/specs/onboarding.md` mapping table).
          enum: [complete, questionnaire_pending, vps_pending, verification_pending, blocked]
        discoveryPreferences:
          type: object
          description: Integrated profiling preference inputs used alongside psychological answers for matchmaking (field name retained for API compatibility).
          properties:
            minAgePreference:
              type: integer
              minimum: 18
              maximum: 120
            maxAgePreference:
              type: integer
              minimum: 18
              maximum: 120
            maxDistanceKm:
              type: integer
              minimum: 1
              maximum: 500
            relationshipIntent:
              type: string
              enum: [casual, serious, marriage, unsure]
            physicalPreferences:
              type: array
              maxItems: 5
              description: Lightweight user-stated physical preference tags captured in integrated profiling and used for affinity scoring.
              items:
                type: string
        createdAt:
          type: string
          format: date-time
        lastActiveAt:
          type: string
          format: date-time

    Location:
      type: object
      required: [city, country]
      properties:
        city:
          type: string
        region:
          type: string
        country:
          type: string
        latitude:
          type: number
        longitude:
          type: number

    Photo:
      type: object
      required: [id, url, isPrimary, createdAt]
      properties:
        id:
          type: string
          format: uuid
        url:
          type: string
          format: uri
        isPrimary:
          type: boolean
        createdAt:
          type: string
          format: date-time

    Question:
      type: object
      required: [id, type, prompt]
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [single_choice, multiple_choice, slider, text, ranking]
        prompt:
          type: string
        description:
          type: string
        options:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              label:
                type: string
        min:
          type: number
        max:
          type: number
        step:
          type: number
        isRequired:
          type: boolean
          default: true
        previousAnswer:
          description: User's previous answer if any
          oneOf:
            - type: string
            - type: number
            - type: array
              items:
                type: string

    VisualPreferenceSession:
      type: object
      required: [sessionId, mode, pairs, expiresAt]
      properties:
        sessionId:
          type: string
          format: uuid
        mode:
          type: string
          enum: [onboarding, recalibration]
        pairs:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/VisualPreferencePair'
        remainingPairs:
          type: integer
          minimum: 0
        confidence:
          type: number
          minimum: 0
          maximum: 1
          description: Current confidence in user visual preference profile.
        expiresAt:
          type: string
          format: date-time

    VisualPreferencePair:
      type: object
      required: [pairId, taskIndex, leftImage, rightImage]
      properties:
        pairId:
          type: string
          format: uuid
        taskIndex:
          type: integer
          minimum: 1
        leftImage:
          $ref: '#/components/schemas/VisualPreferenceImage'
        rightImage:
          $ref: '#/components/schemas/VisualPreferenceImage'

    VisualPreferenceImage:
      type: object
      required: [id, url, sourceMode]
      properties:
        id:
          type: string
          format: uuid
        url:
          type: string
          format: uri
        sourceMode:
          type: string
          enum: [licensed_synthetic, consented_real]
        qualityScore:
          type: number
          minimum: 0
          maximum: 1
        tags:
          type: array
          description: Non-sensitive style tags used for preference modeling.
          items:
            type: string

    VisualPreferenceChoice:
      type: object
      required: [pairId, taskIndex, choice, responseTimeMs]
      properties:
        pairId:
          type: string
          format: uuid
        taskIndex:
          type: integer
          minimum: 1
        choice:
          type: string
          enum: [left, right, neither, skip]
        chosenImageId:
          type: string
          format: uuid
          description: Required for `left` and `right` choices.
        leftImageId:
          type: string
          format: uuid
          description: Echoed client-side for event integrity checks.
        rightImageId:
          type: string
          format: uuid
          description: Echoed client-side for event integrity checks.
        presentedAt:
          type: string
          format: date-time
        respondedAt:
          type: string
          format: date-time
        responseTimeMs:
          type: integer
          minimum: 0
        clientEventId:
          type: string
          description: Client-generated event ID for deduplication.
        deviceId:
          type: string
          description: Optional device identifier used for telemetry integrity.
        skippedReason:
          type: string
          enum: [unsure, neither_preferred, time_limit]

    VisualPreferenceProfile:
      type: object
      required: [status, confidence, completedPairs, updatedAt]
      properties:
        status:
          type: string
          enum: [not_started, in_progress, ready, stale]
        confidence:
          type: number
          minimum: 0
          maximum: 1
        completedPairs:
          type: integer
          minimum: 0
        targetPairs:
          type: integer
          minimum: 1
        refreshRecommended:
          type: boolean
        modelVersion:
          type: string
        latestSnapshotId:
          type: string
          format: uuid
        updatedAt:
          type: string
          format: date-time

    VisualPreferenceProfileSnapshot:
      type: object
      required: [id, status, confidence, completedPairs, modelVersion, createdAt]
      properties:
        id:
          type: string
          format: uuid
        sessionId:
          type: string
          format: uuid
        status:
          type: string
          enum: [in_progress, ready, stale]
        confidence:
          type: number
          minimum: 0
          maximum: 1
        completedPairs:
          type: integer
          minimum: 0
        targetPairs:
          type: integer
          minimum: 1
        modelVersion:
          type: string
        reason:
          type: string
          enum: [initial_build, recalibration, model_upgrade, manual_recompute]
        createdAt:
          type: string
          format: date-time
        metadata:
          type: object

    PhotoRecommendation:
      type: object
      required: [photoId, rank, score]
      properties:
        photoId:
          type: string
          format: uuid
        rank:
          type: integer
          minimum: 1
        score:
          type: number
          minimum: 0
          maximum: 1
        confidence:
          type: number
          minimum: 0
          maximum: 1
        reasons:
          type: array
          items:
            type: string

    MatchOffer:
      type: object
      required: [id, user, status, expiresAt]
      properties:
        id:
          type: string
          format: uuid
        user:
          type: object
          properties:
            id:
              type: string
              format: uuid
            displayName:
              type: string
            age:
              type: integer
            bio:
              type: string
            photos:
              type: array
              items:
                $ref: '#/components/schemas/Photo'
            compatibilityScore:
              type: integer
              minimum: 0
              maximum: 100
            compatibilityThemes:
              type: array
              items:
                type: string
              description: High-level compatibility highlights
            physicalPreferenceScore:
              type: integer
              minimum: 0
              maximum: 100
              description: Affinity to user-stated physical preferences.
        status:
          type: string
          enum: [offered, accepted, passed, expired, not_now, matched]
        expiresAt:
          type: string
          format: date-time
        offeredAt:
          type: string
          format: date-time
        cooldownUntil:
          type: string
          format: date-time
          description: Present for `not_now` offers; when re-offer becomes eligible.

    Match:
      type: object
      required: [id, user, status, createdAt]
      properties:
        id:
          type: string
          format: uuid
        user:
          type: object
          properties:
            id:
              type: string
              format: uuid
            displayName:
              type: string
            age:
              type: integer
            photos:
              type: array
              items:
                $ref: '#/components/schemas/Photo'
        status:
          type: string
          enum: [active, closed]
        closedReason:
          type: string
          enum: [unmatched, blocked, deleted, expired]
        createdAt:
          type: string
          format: date-time
        lastMessageAt:
          type: string
          format: date-time
        unreadCount:
          type: integer

    Message:
      type: object
      required: [id, matchId, senderId, content, createdAt]
      properties:
        id:
          type: string
          format: uuid
        matchId:
          type: string
          format: uuid
        senderId:
          type: string
          format: uuid
        content:
          type: string
        createdAt:
          type: string
          format: date-time
        readAt:
          type: string
          format: date-time
        clientMessageId:
          type: string
          description: Client-generated ID for deduplication

    CohortMetricPoint:
      type: object
      required: [periodStart, value, sampleSize, insufficientData]
      properties:
        periodStart:
          type: string
          format: date
        numerator:
          type: number
        denominator:
          type: number
        value:
          type: number
          description: Metric value (rate or ratio).
        sampleSize:
          type: integer
          minimum: 0
        insufficientData:
          type: boolean

    CohortMetricSeries:
      type: object
      required: [metricKey, cohortDimension, cohortValue, policySegment, region, points]
      properties:
        metricKey:
          type: string
        cohortDimension:
          type: string
          enum: [gender_identity, policy_segment, region]
        cohortValue:
          type: string
        policySegment:
          type: string
          enum: [all, high_inbound_pressure, low_inbound_low_response, balanced]
        region:
          type: string
        points:
          type: array
          items:
            $ref: '#/components/schemas/CohortMetricPoint'

    CohortMetricTimeseriesResponse:
      type: object
      required: [metricKey, metricVersion, granularity, dateFrom, dateTo, generatedAt, series]
      properties:
        metricKey:
          type: string
        metricVersion:
          type: string
        granularity:
          type: string
          enum: [daily, weekly]
        dateFrom:
          type: string
          format: date
        dateTo:
          type: string
          format: date
        generatedAt:
          type: string
          format: date-time
        series:
          type: array
          items:
            $ref: '#/components/schemas/CohortMetricSeries'

    CohortMetricSummaryItem:
      type: object
      required:
        [metricKey, cohortDimension, cohortValue, policySegment, region, latestValue, previousValue, wowDeltaRatio, sampleSize, status]
      properties:
        metricKey:
          type: string
        cohortDimension:
          type: string
          enum: [gender_identity, policy_segment, region]
        cohortValue:
          type: string
        policySegment:
          type: string
          enum: [all, high_inbound_pressure, low_inbound_low_response, balanced]
        region:
          type: string
        latestValue:
          type: number
        previousValue:
          type: number
        wowDeltaRatio:
          type: number
          description: Week-over-week relative delta.
        sampleSize:
          type: integer
          minimum: 0
        status:
          type: string
          enum: [ok, warning, critical, insufficient_data]
        metricVersion:
          type: string

    CohortMetricSummaryResponse:
      type: object
      required: [generatedAt, items]
      properties:
        generatedAt:
          type: string
          format: date-time
        items:
          type: array
          items:
            $ref: '#/components/schemas/CohortMetricSummaryItem'

    CohortMetricAlert:
      type: object
      required:
        [id, metricKey, severity, status, cohortDimension, cohortValue, policySegment, region, observedValue, thresholdValue, detectedAt]
      properties:
        id:
          type: string
          format: uuid
        metricKey:
          type: string
        severity:
          type: string
          enum: [critical, high, medium]
        status:
          type: string
          enum: [open, acknowledged, resolved, muted]
        cohortDimension:
          type: string
          enum: [gender_identity, policy_segment, region]
        cohortValue:
          type: string
        policySegment:
          type: string
          enum: [all, high_inbound_pressure, low_inbound_low_response, balanced]
        region:
          type: string
        observedValue:
          type: number
        baselineValue:
          type: number
        thresholdValue:
          type: number
        deltaRatio:
          type: number
        detectedAt:
          type: string
          format: date-time
        resolvedAt:
          type: string
          format: date-time
        runId:
          type: string
          format: uuid
        details:
          type: object
